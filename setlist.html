<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Setlist arrangement for worship songs">
    <meta name="view-transition" content="same-origin">
    <title>Setlist - Setalight</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="app-container">
        <div id="song-view" class="view">
            <app-header
                id="app-header"
                title="Loading..."
                show-edit-toggle
                show-info-button>
                <div slot="controls" class="header-controls-slot">
                    <button class="reset-button edit-mode-control" id="reset-button" aria-label="Reset song">↺</button>
                    <div class="font-size-controls edit-mode-control">
                        <button class="font-size-btn" id="font-size-decrease" aria-label="Decrease font size">A−</button>
                        <button class="font-size-btn" id="font-size-increase" aria-label="Increase font size">A+</button>
                    </div>
                    <!-- Key display/selector (same button for both modes) -->
                    <div class="key-display-wrapper">
                        <label class="meta-label">Key:</label>
                        <button id="key-selector-button" class="key-selector" popovertarget="key-selector-popover">
                            <span id="key-selector-value">-</span>
                        </button>
                        <div id="key-selector-popover" class="key-popover" popover>
                            <div id="key-options-list" class="key-options-list">
                                <!-- Options populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="song-meta-compact" id="song-meta-header"></div>
                </div>
            </app-header>

            <!-- Navigation menu component -->
            <nav-menu id="nav-menu" show-back-button back-label="Back"></nav-menu>

            <main id="main-content">
                <div class="song-container">
                    <p>Loading setlist...</p>
                </div>
            </main>
        </div>

        <!-- Song info modal -->
        <app-modal id="song-info-modal" size="fullscreen">
            <div id="modal-body"></div>
        </app-modal>

        <!-- Reset confirmation modal -->
        <app-modal
            id="reset-confirm-modal"
            type="confirm"
            title="Reset Song?"
            message="This will reset the key, BPM, font size, and all section states back to defaults. This cannot be undone."
            confirm-label="Reset"
            cancel-label="Cancel">
        </app-modal>

        <!-- Add Song modal -->
        <app-modal id="add-song-modal" size="fullscreen">
            <div slot="header" class="song-library-header">
                <input
                    type="text"
                    id="add-song-search-input"
                    class="song-search-input"
                    placeholder="Search songs by title, artist, or lyrics..."
                    autocomplete="off"
                >
            </div>
            <div id="add-song-results" class="song-library-list">
                <p style="text-align: center; color: #95a5a6;">Start typing to search songs...</p>
            </div>
        </app-modal>

        <!-- Delete Song confirmation modal -->
        <app-modal
            id="delete-song-modal"
            type="confirm"
            title="Remove Song from Setlist?"
            confirm-label="Remove"
            cancel-label="Cancel">
            <p>Are you sure you want to remove "<strong id="delete-song-title"></strong>" from this setlist?</p>
        </app-modal>

        <!-- Media Player (floating bottom-right) -->
        <media-player id="media-player" style="position: fixed; bottom: 1rem; right: 1rem; z-index: 1000;"></media-player>
    </div>

    <!-- Template for key option item -->
    <template id="key-option-template">
        <button class="key-option-item">
            <span class="key-name"></span>
            <span class="key-offset"></span>
        </button>
    </template>

    <!-- Template for song info modal item -->
    <template id="song-info-item-template">
        <div class="modal-info-item">
            <div class="modal-info-label"></div>
            <div class="modal-info-value"></div>
        </div>
    </template>

    <!-- Import map for Lit -->
    <script type="importmap">
    {
        "imports": {
            "lit": "https://cdn.jsdelivr.net/npm/lit@3.1.0/index.js",
            "lit/": "https://cdn.jsdelivr.net/npm/lit@3.1.0/",
            "@lit/reactive-element": "https://cdn.jsdelivr.net/npm/@lit/reactive-element@2.0.4/reactive-element.js",
            "@lit/reactive-element/": "https://cdn.jsdelivr.net/npm/@lit/reactive-element@2.0.4/",
            "lit-element/lit-element.js": "https://cdn.jsdelivr.net/npm/lit-element@4.0.4/lit-element.js",
            "lit-html": "https://cdn.jsdelivr.net/npm/lit-html@3.1.0/lit-html.js",
            "lit-html/": "https://cdn.jsdelivr.net/npm/lit-html@3.1.0/"
        }
    }
    </script>

    <script>
        // Set window name so bookmarklet can find and reuse this tab
        window.name = 'setalight';

        // Check media player settings and conditionally render
        function updateMediaPlayerVisibility() {
            const mediaPlayer = document.getElementById('media-player');
            if (!mediaPlayer) return;

            const savedSettings = localStorage.getItem('mediaPlayerSettings');
            const settings = savedSettings ? JSON.parse(savedSettings) : { mediaPlayerEnabled: true };

            // Hide/show media player based on global setting
            if (settings.mediaPlayerEnabled === false) {
                mediaPlayer.style.display = 'none';
            } else {
                mediaPlayer.style.display = '';
            }
        }

        // Update on page load
        customElements.whenDefined('media-player').then(() => {
            updateMediaPlayerVisibility();
        });

        // Update when settings change (from settings page)
        window.addEventListener('media-player-settings-changed', () => {
            updateMediaPlayerVisibility();
        });
    </script>
    <!-- Import the components -->
    <script type="module" src="/components/song-card.js"></script>
    <script type="module" src="/components/app-header.js"></script>
    <script type="module" src="/components/nav-menu.js"></script>
    <script type="module" src="/components/app-modal.js"></script>
    <script type="module" src="/components/media-player-settings.js"></script>
    <script type="module" src="/components/media-player.js"></script>
    <script type="module" src="/js/setlist-app.js"></script>
</body>
</html>
