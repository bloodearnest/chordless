<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Media Player Test - Chordless</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
        background: #ecf0f1;
      }

      h1 {
        color: #2c3e50;
      }

      .test-controls {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .test-controls h2 {
        margin-top: 0;
        color: #34495e;
      }

      .button-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      button {
        padding: 0.5rem 1rem;
        border: 2px solid #3498db;
        background: white;
        color: #3498db;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
      }

      button:hover {
        background: #3498db;
        color: white;
      }

      button.active {
        background: #3498db;
        color: white;
      }

      .player-container {
        margin-top: 2rem;
      }

      .info-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .info-box h3 {
        margin-top: 0;
        color: #856404;
      }

      code {
        background: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
      }
    </style>
  </head>
  <body>
    <h1>üéµ Media Player Component Test</h1>

    <div class="test-controls" style="margin-bottom: 2rem">
      <media-player-settings></media-player-settings>
    </div>

    <div class="test-controls">
      <h2>Key Selection</h2>
      <p>Click a key to simulate a <code>song-change</code> event:</p>
      <div class="button-group" id="key-buttons">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <div class="test-controls">
      <h2>Tempo ¬∑ Time Signature</h2>
      <p>Picking a preset dispatches the same event the media player receives in the app:</p>
      <div class="button-group" id="tempo-buttons">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <div class="player-container">
      <media-player id="player" current-key="C" bpm="120" time-signature="4/4"></media-player>
    </div>

    <div class="info-box">
      <h3>‚ÑπÔ∏è How it works</h3>
      <ul>
        <li>Click the play button (or press <code>Space</code>) to start/stop the pad audio</li>
        <li>Audio fades in/out over 5 seconds and crossfades between keys</li>
        <li>
          The key/tempo controls dispatch full <code>song-change</code> payloads (key, tempo, tempo
          note, time signature)
        </li>
        <li>
          The metronome honours compound signatures and tempo hints such as <code>152 (1/8)</code>
        </li>
        <li>
          Pads download lazily; the status LED shows <strong>DOWNLOAD</strong> while a key is
          caching
        </li>
        <li>Press <code>Escape</code> or click ‚èπ to stop everything immediately</li>
      </ul>
    </div>

    <!-- Import map for Lit -->
    <script type="importmap">
      {
        "imports": {
          "lit": "/vendor/lit/index.js",
          "lit/": "/vendor/lit/",
          "@lit/reactive-element": "/vendor/@lit/reactive-element/reactive-element.js",
          "@lit/reactive-element/": "/vendor/@lit/reactive-element/",
          "lit-element/lit-element.js": "/vendor/lit-element/lit-element.js",
          "lit-html": "/vendor/lit-html/lit-html.js",
          "lit-html/": "/vendor/lit-html/"
        }
      }
    </script>

    <script type="module">
      import '/components/media-player.js';
      import '/components/media-player-settings.js';

      const player = document.getElementById('player');
      const state = {
        key: 'C',
        tempo: 120,
        tempoNote: '1/4',
        timeSignature: '4/4',
        counter: 0,
      };

      const keys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const keyButtonContainer = document.getElementById('key-buttons');
      keys.forEach(key => {
        const button = document.createElement('button');
        button.textContent = key;
        button.addEventListener('click', () => {
          document
            .querySelectorAll('#key-buttons button')
            .forEach(b => b.classList.remove('active'));
          button.classList.add('active');
          state.key = key;
          sendSongChange();
        });
        if (key === state.key) {
          button.classList.add('active');
        }
        keyButtonContainer.appendChild(button);
      });

      const tempoPresets = [
        { bpm: 60, time: '4/4', tempoNote: '1/4', label: '60 ¬∑ 4/4' },
        { bpm: 80, time: '3/4', tempoNote: '1/4', label: '80 ¬∑ 3/4' },
        { bpm: 100, time: '6/8', tempoNote: '1/4', label: '100 ¬∑ 6/8' },
        { bpm: 120, time: '4/4', tempoNote: '1/8', label: '120 ¬∑ 4/4 (1/8 feel)' },
        { bpm: 152, time: '4/4', tempoNote: '1/8', label: '152 ¬∑ 4/4 (1/8)' },
        { bpm: 90, time: '3/4', tempoNote: '1/8', label: '90 ¬∑ 3/4 (1/8)' },
        { bpm: 72, time: '6/8', tempoNote: '3/8', label: '72 ¬∑ 6/8 (3/8)' },
      ];

      const tempoButtonContainer = document.getElementById('tempo-buttons');
      tempoPresets.forEach(preset => {
        const button = document.createElement('button');
        button.textContent = preset.label;
        button.addEventListener('click', () => {
          document
            .querySelectorAll('#tempo-buttons button')
            .forEach(b => b.classList.remove('active'));
          button.classList.add('active');
          state.tempo = preset.bpm;
          state.timeSignature = preset.time;
          state.tempoNote = preset.tempoNote || '1/4';
          sendSongChange();
        });
        if (preset.bpm === state.tempo && preset.time === state.timeSignature) {
          button.classList.add('active');
        }
        tempoButtonContainer.appendChild(button);
      });

      function sendSongChange() {
        state.counter += 1;
        const song = {
          songId: `demo-song-${state.counter}`,
          title: `Demo Song ${state.counter}`,
          metadata: {
            key: state.key,
            tempo: state.tempo,
            tempoNote: state.tempoNote,
            timeSignature: state.timeSignature,
          },
        };
        document.dispatchEvent(new CustomEvent('song-change', { detail: { song } }));
      }

      async function initSongFeed() {
        await customElements.whenDefined('media-player');
        sendSongChange();
      }

      initSongFeed();

      player.addEventListener('play-state-change', e => {
        console.log('Player state changed:', e.detail);
      });
    </script>
  </body>
</html>
